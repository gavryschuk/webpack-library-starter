<html>
  <head>
    <title>Words Library Client</title>
    <link rel="stylesheet" href="./index.css">
    <script   src="https://code.jquery.com/jquery-3.3.1.js"   integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="   crossorigin="anonymous"></script>
    <script src='./wordsai.min.js'></script>
  </head>
  <body>
    <script>
      
      let start = function(){
        $("body").empty();
        $('body').append('Loading dictionaries...');
        setTimeout(()=>{createAI();},1000);
      }

      loadDictionary = ( filePath, callback = null ) =>{
        let rawFile = new XMLHttpRequest();
        rawFile.open("GET", filePath, false);
        rawFile.onreadystatechange = function () {
          if(rawFile.readyState === 4) 
            if(rawFile.status === 200 || rawFile.status == 0){
              $('body').append('<br/>Loaded ' + rawFile.responseURL);
              if(callback) setTimeout(()=>{callback(rawFile);},500);
            }
        }
        rawFile.send(null);
      }

      let createAI = (  ) => {
        window.BE = new wordsai.BE();
        window.FE = new wordsai.FE();
        window.try = 0;
        window.dictionaries = [
          { path: './en.txt'},
          { path: './sat.txt'},
          { path: './toefl.txt'}
        ];
        dictionariesCounter = 0;
        let loadCallback = (element)=>{
          console.error(element);
          $('body').append('<br/>Adding dictionary ' + element.responseURL.toString() + ' ...');
          setTimeout(()=>{
            dictionariesCounter++;
            if(element.responseURL.toString().includes('en.txt') ) window.BE.loadMainDictionary(element.responseText);
            else window.BE.loadSecondaryDictionary(element.responseURL.toString(), element.responseText);
            console.log(element.responseURL.toString());
            if(dictionariesCounter === window.dictionaries.length){
              console.log('starting board');
              window.FE.startBoard(10);
              console.log(window.FE.board);
              
              chooseDictionary();
            }
          },500);
        }
        dictionaries.forEach( (element) => {
          loadDictionary(element.path, loadCallback );
        });
      };

      let chooseDictionary = ()=>{
        $("body").empty();
        let dicts = window.BE.getSecondaryDictionaries();
        let userInputHTML = '<div id="userInputDiv">';
            userInputHTML += 'Pick up dictionary: <br>';
            userInputHTML += '<select id="userInputDictionary">';
              dicts.forEach((element,index)=>{
                userInputHTML += '<option value="'+element+'" '+((!index) ? 'selected="selected"' : '') +'>'+element+'</option>';
              });
              userInputHTML += '</select><br/>';
            userInputHTML += '<input type="button" value="choose" onClick="javascript:window.selectedDictionary=$(\'#userInputDictionary\').val();startBoard();"><br/>';
            userInputHTML += '</div>';
            $('body').append( userInputHTML );
      }

      let startBoard = ()=>{
        $("body").empty();       
        $('body').append('<br/>Searching for initial word ...');
        let regExps = window.FE.getPossibleWordRegExp();
        $('body').append('<br/>');
          regExps.forEach((element,index)=>{
            $('body').append(index + ' : ' + element.toString());
            $('body').append('<br/>');
          })
          let hintsArray = window.BE.getHint(regExps, window.selectedDictionary);
          let hint = window.FE.getHintFromWordsArray(hintsArray);
          $('body').append('<br/>');
          $('body').append('Hint:' + hint );
          $('body').append('<br/>Adding to the board.....<br/>');
          window.FE.addWordRandomly(hint);
          regExps = null;
          hintsArray = null;
          appendBoard();
      }

      let appendBoard = ()=>{
        // $('div').last().remove();
        $('input').last().remove();
        $('body').append('<br/>Try: ' + window.try);
        $('body').append('<br/>Points:'+ window.FE.points + '</br>');
        $('body').append('<table></table>');
        for(let y = 0; y<window.FE.boardSize; y++){
          let str = '<tr>';
          for(let x = 0; x<window.FE.boardSize; x++){
            let element = window.FE.board[y][x];
            let classType = 'blue';
            if(typeof element !== 'string'){
              switch(parseInt(element)){
                case 0:
                  classType = 'yellow';
                  break;
                case 1:
                  classType = 'orange';
                  break;
                case 2:
                  classType = 'orangered';
                  break;
                case 4:
                  classType = 'green';
                  break;
                case 5:
                  classType = 'greenyellow';
                  break;
                default:
                  classType = 'red';
                  break;
              }
            }
            
            let classString = 'class="'+ classType + '"';
            str += '<td ' + classString + ' >'+element+'</td>';
          }
          str += '</tr>';
          $('table').last().append( str );
        }

        appendHint();
        window.try++;
        $("html, body").animate({ scrollTop: $(document).height() }, 1000);
      }

      let appendHint = () => {
        $('body').append('<div>Looking For A hint. Please Wait. If no hint found -> you will see the notification.</div>');
        setTimeout(()=>{
          $('div').last().remove();
          let regExps = window.FE.getPossibleWordRegExp();
          $('body').append('<br/>');
          regExps.forEach((element,index)=>{
            $('body').append(index + ' : ' + element.toString());
            $('body').append('<br/>');
          })
          let hintsArray = window.BE.getHint(regExps,window.selectedDictionary);
          let hint = window.FE.getHintFromWordsArray(hintsArray);
          $('body').append('<br/>');
          $('body').append('Hint:' + hint );
          regExps = null;
          hintsArray = null;
          if( hint ) {
            $('body').append('<br/>');
            $('body').append('<input type="button" value="add hint randomly" onClick="javascript:addWordRandomly(\'' + hint + '\');"/>');
            appendUserWord();
          } else {
            $('body').append('<div>No Hint found! Game Over. Reload the page.</div>');
          }
        },1000);
      }

      let appendUserWord = () => {
        let userInputHTML = '<div id="userInputDiv">';
            userInputHTML += 'USER Word: <br>';
            userInputHTML += 'x:<input type="number" id="userInputX" min="0" max="13" value="0"><br/>';
            userInputHTML += 'y:<input type="number" id="userInputY" min="0" max="13" value="0"><br/>';
            userInputHTML += 'vertical: <select id="userInputVertical"><option value="0">false</option><option value="1">true</option></select><br/>';
            userInputHTML += 'word:<input type="text" id="userInputWord"><br/>';
            userInputHTML += '<input type="button" value="add user word" onClick="javascript:insertWord(parseInt($(\'#userInputX\').val()),parseInt($(\'#userInputY\').val()),!!parseInt($(\'#userInputVertical\').val()),$(\'#userInputWord\').val().toString());"><br/>';
            userInputHTML += '</div>';
            $('body').append( userInputHTML );
      }

      let addWordRandomly = (word)=>{
        let stats = window.BE.getWordStats(word, window.selectedDictionary);
        if(stats.exists){
          if(window.FE.addWordRandomly( word, stats.points )){ 
            $('#userInputDiv').last().remove();
            appendBoard();
          }else {
            $('body').append('<div>Error! Word is not added.</div>');
          }
        }else{
          $('body').append('<div>Error! Word doesn\'t exist.</div>');
        }
      }

      let insertWord = ( x, y, vertical, word) => {
        let stats = window.BE.getWordStats(word, window.selectedDictionary);
        if(stats.exists){
          if(window.FE.addWord(x, y, word, vertical, stats.points)){ 
            $('#userInputDiv').last().remove();
            appendBoard();
          }else {
            $('body').append('<div>Error! Word is not added.</div>');
          }
        }else{
          $('body').append('<div>Error! Word doesn\'t exist.</div>');
        }

      }

      // run
      $("body").append('<input type="button" value="START" onClick="javascript:start();"/>');
      
    </script>
  </body>
</html>